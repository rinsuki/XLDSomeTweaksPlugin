name: Build
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-26
    steps:
    - run: sudo xcode-select -s /Applications/Xcode_26.0.app
    - run: brew install subversion
    - uses: actions/checkout@v5
    - run: xcrun agvtool new-version -all ${{ github.run_id }}
    - run: ./download_third_party.sh
    - run: xcodebuild archive -scheme XLDSomeTweaksPlugin -archivePath build
    - name: Create zip
      run: |
        pushd build.xcarchive/Products/Library/Bundles
        zip -9r XLDSomeTweaksPlugin.zip XLDSomeTweaksPlugin.bundle
        mv XLDSomeTweaksPlugin.zip ../../../../
        popd
    - uses: actions/upload-artifact@v5
      with:
        name: XLDSomeTweaksPlugin
        path: XLDSomeTweaksPlugin.zip
    - run:
        echo "version_human=$(defaults read $(pwd)/build.xcarchive/Products/Library/Bundles/XLDSomeTweaksPlugin.bundle/Contents/Info CFBundleShortVersionString)" >> $GITHUB_OUTPUT
  create_draft_release:
    runs-on: ubuntu-24.04
    needs: [build]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      id-token: write
      attestations: write
    steps:
    - uses: actions/checkout@v5
    - uses: actions/download-artifact@v6
      with:
        name: XLDSomeTweaksPlugin
    - uses: actions/attest-build-provenance@v3
      id: attest
      with:
        subject-path: "*.zip"
    - name: Create Draft Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        VERSION="v${{ needs.build.outputs.full_version }}"
        gh release create "$VERSION" \
          --draft \
          --title "$VERSION (${{ github.run_id }})" \
          --notes "Draft release created by workflow_dispatch\n\n<small>ðŸ¤“ Attestation: ${{ steps.attest.outputs.attestation-url }}</small>" \
          *.zip
